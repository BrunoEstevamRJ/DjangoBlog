{% extends "base.html" %}
{% load static %}

{% block title %}
{{ post.title }}
{% endblock %}

{% block content %}
<div class="container">
    <br>

    <!-- Bot√£o de Voltar -->
    <div class="d-flex justify-content-start mb-3">
	{% if request.META.HTTP_REFERER %}
    <a href="{{ request.META.HTTP_REFERER }}" class="btn btn-outline-secondary">
        ‚Ü©Ô∏è Voltar
    </a>
{% else %}
    <a href="{% url 'blog:homepage' %}" class="btn btn-outline-secondary">
        ‚Ü©Ô∏è Voltar
    </a>
{% endif %}

    </div>

    <div class="row justify-content-md-center pt-5">
        <div class="col-md-8">

            <h1 class="mb-2">{{ post.title }}</h1>

            <!-- Autor do post -->
            <p class="text-muted">
                Publicado por
                <a href="{% url 'accounts:profile' post.author.username %}">
                    {{ post.author.username }}
                </a>
            </p>

            <div class="col-12">
                <p>{{ post.content|safe }}</p>

                {% if post.image %}
                <img src="{{ post.image.url }}" class="img-fluid" alt="{{ post.title }}">
                {% endif %}
            </div>

            <!-- Likes -->
            <div class="d-flex flex-wrap gap-2 justify-content-center mt-4">
                <button class="btn btn-success like-btn w-25" data-slug="{{ post.slug }}">
                    üëç Like (<span class="like-count">{{ post.total_likes }}</span>)
                </button>

                <button class="btn btn-danger dislike-btn w-25" data-slug="{{ post.slug }}">
                    üëé Dislike (<span class="dislike-count">{{ post.total_dislikes }}</span>)
                </button>

                {% if user == post.author %}
                <a href="{% url 'blog:edit_post' post.slug %}" class="btn btn-outline-primary w-25">
                    ‚úèÔ∏è Editar
                </a>
                {% endif %}
            </div>

            <hr>

            <!-- Coment√°rio principal -->
            <h3>Deixe um coment√°rio</h3>

            {% if user.is_authenticated %}
            <form method="post" action="{% url 'blog:add_comment' post.slug %}">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="id_content" class="form-label">Seu coment√°rio:</label>
                    <textarea name="content" id="id_content" class="form-control" rows="3" required style="resize: none;"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Enviar</button>
            </form>
            {% else %}
            <p><a href="{% url 'blog:login' %}">Fa√ßa login</a> para comentar.</p>
            {% endif %}

            <hr>

            <!-- Coment√°rios -->
            <h2>Coment√°rios</h2>

            <div class="comments">
                {% for comment in post.comments.all %}
                    {% if comment.parent is None %}
                    <div class="comment" id="comment-{{ comment.id }}">

                        <div class="comment-content">
                            <p>
                                <strong>
                                    <a href="{% url 'accounts:profile' comment.author.username %}">
                                        {{ comment.author.username }}
                                    </a>
                                </strong>
                                : {{ comment.content }}
                            </p>

                            <small>{{ comment.created_at }}</small>

                            <div class="mt-1">
                                <a href="#" class="reply-link btn btn-sm btn-link" data-comment-id="{{ comment.id }}">
                                    Responder
                                </a>

                                {% if user == comment.author %}
                                <button class="btn btn-sm btn-danger delete-comment"
                                        data-id="{{ comment.id }}"
                                        data-url="{% url 'blog:delete_comment' comment.id %}">
                                    üóëÔ∏è Apagar
                                </button>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Form resposta -->
                        <div class="reply-form" id="reply-form-{{ comment.id }}" style="display: none; margin-left: 40px;">
                            <form method="post" action="{% url 'blog:reply_comment' post.slug comment.id %}">
                                {% csrf_token %}
                                <div class="mb-2">
                                    <textarea name="content" class="form-control" rows="2"
                                              placeholder="Escreva sua resposta..." required></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary btn-sm">Enviar</button>
                                <button type="button" class="btn btn-secondary btn-sm cancel-reply"
                                        data-comment-id="{{ comment.id }}">
                                    Cancelar
                                </button>
                            </form>
                        </div>

                        <!-- Replies -->
                        <div class="replies" style="margin-left: 40px; border-left: 2px solid #dee2e6; padding-left: 20px;">
                            {% for reply in comment.replies.all %}
                            <div class="reply" id="comment-{{ reply.id }}">
                                <div class="reply-content">
                                    <p>
                                        <strong>
                                            <a href="{% url 'accounts:profile' reply.author.username %}">
                                                {{ reply.author.username }}
                                            </a>
                                        </strong>
                                        : {{ reply.content }}
                                    </p>

                                    <small>{{ reply.created_at }}</small>

                                    <div class="mt-1">
                                        <a href="#" class="reply-link btn btn-sm btn-link"
                                           data-comment-id="{{ reply.id }}">
                                            Responder
                                        </a>

                                        {% if user == reply.author %}
                                        <button class="btn btn-sm btn-danger delete-comment"
                                                data-id="{{ reply.id }}"
                                                data-url="{% url 'blog:delete_comment' reply.id %}">
                                            üóëÔ∏è Apagar
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Resposta aninhada -->
                                <div class="reply-form" id="reply-form-{{ reply.id }}"
                                     style="display: none; margin-left: 20px;">
                                    <form method="post"
                                          action="{% url 'blog:reply_comment' post.slug reply.id %}">
                                        {% csrf_token %}
                                        <div class="mb-2">
                                            <textarea name="content" class="form-control" rows="2"
                                                      placeholder="Escreva sua resposta..." required></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-primary btn-sm">Enviar</button>
                                        <button type="button" class="btn btn-secondary btn-sm cancel-reply"
                                                data-comment-id="{{ reply.id }}">
                                            Cancelar
                                        </button>
                                    </form>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                    </div>
                    {% endif %}
                {% empty %}
                    <p>Sem coment√°rios ainda. Seja o primeiro a comentar!</p>
                {% endfor %}
            </div>

            <style>
                .comment {
                    margin-bottom: 20px;
                }

                .comment-content,
                .reply-content {
                    background-color: #f8f9fa;
                    padding: 10px;
                    border-radius: 5px;
                    margin-bottom: 10px;
                }

                .comment-content a,
                .reply-content a {
                    text-decoration: none;
                    font-weight: 600;
                }

                .comment-content a:hover,
                .reply-content a:hover {
                    text-decoration: underline;
                }

                .reply {
                    margin-bottom: 15px;
                }
            </style>

        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
$(document).ready(function () {

    $(".delete-comment").on("click", function () {
        const button = $(this);
        const commentId = button.data("id");
        const deleteUrl = button.data("url");
        const csrfToken = "{{ csrf_token }}";

        if (!confirm("Tem certeza que deseja excluir este coment√°rio?")) return;

        $.ajax({
            type: "POST",
            url: deleteUrl,
            headers: { "X-CSRFToken": csrfToken },
            success: function (response) {
                if (response.success) {
                    $("#comment-" + commentId).fadeOut(300, function () {
                        $(this).remove();
                    });
                }
            }
        });
    });

    $('.like-btn').on('click', function (e) {
        e.preventDefault();
        const slug = $(this).data('slug');
        const url = "{% url 'blog:like_post' 'x' %}".replace('x', slug);

        $.ajax({
            type: 'POST',
            url: url,
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            success: function (response) {
                $('.like-count').text(response.total_likes);
                $('.dislike-count').text(response.total_dislikes);
            }
        });
    });

    $('.dislike-btn').on('click', function (e) {
        e.preventDefault();
        const slug = $(this).data('slug');
        const url = "{% url 'blog:dislike_post' 'x' %}".replace('x', slug);

        $.ajax({
            type: 'POST',
            url: url,
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            success: function (response) {
                $('.like-count').text(response.total_likes);
                $('.dislike-count').text(response.total_dislikes);
            }
        });
    });

});

document.addEventListener('DOMContentLoaded', function () {

    document.querySelectorAll('.reply-link').forEach(link => {
        link.addEventListener('click', e => {
            e.preventDefault();
            document.getElementById(
                `reply-form-${link.dataset.commentId}`
            ).style.display = 'block';
        });
    });

    document.querySelectorAll('.cancel-reply').forEach(btn => {
        btn.addEventListener('click', () => {
            document.getElementById(
                `reply-form-${btn.dataset.commentId}`
            ).style.display = 'none';
        });
    });

});
</script>

{% endblock %}

